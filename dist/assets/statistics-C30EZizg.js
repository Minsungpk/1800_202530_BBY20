import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{a as G,d as p}from"./firebaseConfig-xSN_xHYb.js";import{onAuthStateChanged as _}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{doc as k,getDoc as R,Timestamp as F,query as I,collection as E,where as x,orderBy as z,getDocs as P,deleteDoc as Q,runTransaction as N,increment as O,serverTimestamp as T,addDoc as D,updateDoc as U,setDoc as W}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";import{l as Y}from"./logout-CMZ6WfQS.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";let r=null,g=null;const t={authMsg:document.getElementById("authMsg"),kpiOnTime:document.getElementById("kpi-onTime"),kpiOnTimeMeta:document.getElementById("kpi-onTime-meta"),kpiArrivals:document.getElementById("kpi-arrivals"),kpiCompletions:document.getElementById("kpi-completions"),kpiPoints:document.getElementById("kpi-points"),kpiPointsMeta:document.getElementById("kpi-points-meta"),redeemBtn:document.getElementById("redeemBtn"),openStoreBtn:document.getElementById("openStoreBtn"),rewardsModal:document.getElementById("rewardsModal"),closeStoreBtn:document.getElementById("closeStoreBtn"),rewardsGrid:document.getElementById("rewardsGrid"),equippedBadgeDisplay:document.getElementById("equippedBadgeDisplay"),trendChart:document.getElementById("trendChart"),seedBtn:document.getElementById("seedBtn"),activityTimeline:document.getElementById("activityTimeline"),showMoreContainer:document.getElementById("showMoreContainer"),clearActivityBtn:document.getElementById("clearActivityBtn")},M=[{id:"badge_time_master",name:"Time Master",emoji:"‚è∞",cost:100,desc:"Shows superior punctuality."},{id:"badge_consistency",name:"Consistency Champ",emoji:"üåü",cost:100,desc:"Awarded for persistent effort."},{id:"badge_focus",name:"Laser Focus",emoji:"üéØ",cost:100,desc:"Represents sharp task execution."},{id:"badge_velocity",name:"Speed Runner",emoji:"‚ö°",cost:100,desc:"You move fast and finish early."},{id:"badge_resilience",name:"Unstoppable",emoji:"üî•",cost:100,desc:"Nothing slows you down."},{id:"badge_elite",name:"Elite Planner",emoji:"üìÖ",cost:100,desc:"Meticulous scheduling skills."}];let f={points:0,owned:{},equipped:null};_(G,e=>{if(r=e||null,!r){t.authMsg.textContent="Please log in to view your statistics.",X();return}t.authMsg.textContent="",Promise.all([$(r.uid),S(r.uid)]).catch(i=>console.error(i))});async function S(e){try{const i=k(p,"userRewards",e),n=await R(i),o=n.exists()&&n.data().points||0;t.kpiPoints.textContent=o.toString(),t.kpiPointsMeta.textContent="Points earned",t.redeemBtn&&(o>=1e3?(t.redeemBtn.style.display="inline-block",t.redeemBtn.disabled=!1,t.redeemBtn.textContent="Redeem 1000"):t.redeemBtn.style.display="none"),f.points=o,n.exists()&&(f.owned=n.data().owned||{},f.equipped=n.data().equippedBadge||null),H()}catch(i){console.error("Could not load points",i),t.kpiPoints.textContent="‚Äî"}}function H(){if(!t.equippedBadgeDisplay)return;if(!f.equipped){t.equippedBadgeDisplay.style.display="none";return}const e=M.find(i=>i.id===f.equipped);if(!e){t.equippedBadgeDisplay.style.display="none";return}t.equippedBadgeDisplay.innerHTML=`${e.emoji} <span>${e.name}</span>`,t.equippedBadgeDisplay.style.display="inline-flex"}function J(){t.rewardsModal&&(t.rewardsModal.style.display="flex",A())}function j(){t.rewardsModal&&(t.rewardsModal.style.display="none")}function A(){t.rewardsGrid&&(t.rewardsGrid.innerHTML="",M.forEach(e=>{const i=!!f.owned[e.id],n=f.equipped===e.id,o=f.points>=e.cost,a=document.createElement("div");a.className="col-12 col-sm-6 col-lg-4 mb-3",a.innerHTML=`
      <div class="border rounded p-3 h-100 d-flex flex-column" style="background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <div style="font-size:2rem;">${e.emoji}</div>
        <h6 class="mt-2 mb-1" style="font-weight:700;">${e.name}</h6>
        <div class="small text-muted mb-2">${e.desc}</div>
        <div class="mb-2"><span class="badge bg-warning text-dark">Cost: ${e.cost}</span></div>
        <div class="mt-auto d-flex flex-wrap gap-2">
          ${i?`<button class="btn btn-sm btn-outline-secondary equip-btn" data-id="${e.id}" ${n?"disabled":""}>${n?"Equipped":"Equip"}</button>`:`<button class="btn btn-sm btn-primary buy-btn" data-id="${e.id}" ${o?"":"disabled"}>${o?"Buy":"Need "+(e.cost-f.points)}</button>`}
        </div>
      </div>`,t.rewardsGrid.appendChild(a)}),t.rewardsGrid.querySelectorAll(".buy-btn").forEach(e=>{e.addEventListener("click",()=>K(e.dataset.id))}),t.rewardsGrid.querySelectorAll(".equip-btn").forEach(e=>{e.addEventListener("click",()=>V(e.dataset.id))}))}async function K(e){const i=M.find(n=>n.id===e);if(i){if(!r){alert("Please log in");return}try{await N(p,async n=>{const o=k(p,"userRewards",r.uid),a=await n.get(o),l=a.exists()?a.data():{points:0},c=l.points||0,d=l.owned||{};if(d[e])throw new Error("Already owned");if(c<i.cost)throw new Error("Not enough points");d[e]={acquiredAt:Date.now()},n.set(o,{points:c-i.cost,owned:d},{merge:!0})}),await S(r.uid),A(),alert(`Purchased ${i.name}!`)}catch(n){console.error("Purchase failed",n),alert(n.message||"Purchase failed")}}}async function V(e){if(M.find(n=>n.id===e)){if(!r){alert("Please log in");return}try{await U(k(p,"userRewards",r.uid),{equippedBadge:e}),f.equipped=e,H(),A()}catch(n){console.error("Equip failed",n),alert("Could not equip badge")}}}function X(){t.kpiOnTime.textContent="‚Äî",t.kpiArrivals.textContent="‚Äî",t.kpiCompletions.textContent="‚Äî",g&&(g.destroy(),g=null)}async function $(e){const i=new Date;i.setDate(i.getDate()-30);const n=F.fromDate(i),o=I(E(p,"events"),x("userUid","==",e),x("timestamp",">=",n),z("timestamp","asc")),a=await P(o),l=[],c=[],d={};a.forEach(y=>{const m=y.data(),q=m.timestamp&&m.timestamp.toDate?m.timestamp.toDate():new Date;let b=q;try{const w=m.meta||{};if(w.completedTime){const u=w.completedTime,v=typeof u=="number"?new Date(u):new Date(u);isNaN(v.getTime())||(b=v)}else if(w.scheduledTime){const u=w.scheduledTime,v=typeof u=="number"?new Date(u):new Date(u);isNaN(v.getTime())||(b=v)}else if(w.arrivalTime){const u=w.arrivalTime,v=typeof u=="number"?new Date(u):new Date(u);isNaN(v.getTime())||(b=v)}}catch(w){console.warn("Could not parse meta time for event",w),b=q}const C=b.toISOString().slice(0,10),L={day:C,type:m.type,timestamp:m.timestamp&&m.timestamp.toDate?m.timestamp.toDate():new Date,meta:m.meta||{},raw:m};d[C]||(d[C]={arrivals:0,completions:0}),m.type==="arrival"?(l.push(L),d[C].arrivals+=1):m.type==="completion"&&(c.push(L),d[C].completions+=1)});const s=l.length,h=l.filter(y=>y.meta&&y.meta.onTime).length,B=c.length;t.kpiArrivals.textContent=s.toString(),t.kpiCompletions.textContent=B.toString(),t.kpiOnTime.textContent=s?Math.round(h/s*100)+"%":"‚Äî",t.kpiOnTimeMeta.textContent=s?`${h} / ${s} arrivals on time`:"No arrival data",ee(d);try{Z(l,c)}catch(y){console.warn("Timeline render failed",y)}}function Z(e,i){const n=[...e.map(a=>({...a,type:"arrival"})),...i.map(a=>({...a,type:"completion"}))].sort((a,l)=>l.timestamp-a.timestamp),o=t.activityTimeline;if(o.innerHTML="",n.length===0){o.innerHTML=`
      <div class="empty-timeline">
        <i class="fas fa-inbox"></i>
        <p>No activity yet. Start completing tasks or recording arrivals!</p>
      </div>
    `,t.showMoreContainer.innerHTML="",t.clearActivityBtn.style.display="none";return}if(t.clearActivityBtn.style.display="block",n.forEach((a,l)=>{const c=document.createElement("div");c.className=`timeline-item ${a.type}`;const d=a.timestamp.toLocaleString(),s=a.meta||{};let h="",B="",y="";a.type==="completion"?(B="‚úì",h=`<strong>${s.taskText||"Task completed"}</strong>`,s.onTime!==void 0&&(y=s.onTime?'<span class="timeline-badge">On-Time ‚úì</span>':'<span class="timeline-badge">Late</span>')):a.type==="arrival"&&(B="üìç",h=`<strong>Arrival at ${s.locationId||"Location"}</strong>`,s.onTime!==void 0&&(y=s.onTime?'<span class="timeline-badge">On-Time ‚úì</span>':'<span class="timeline-badge">Late</span>')),c.innerHTML=`
      <div class="timeline-dot">${B}</div>
      <div class="timeline-content">
        <div class="timeline-time">${d}</div>
        <div class="timeline-desc">${h}</div>
        <div class="timeline-meta">
          ${y}
          ${s.scheduledTime?`<span><i class="fas fa-calendar"></i> Scheduled: ${new Date(s.scheduledTime).toLocaleString()}</span>`:""}
        </div>
      </div>
    `,o.appendChild(c)}),n.length>3){const a=n.length-3;t.showMoreContainer.innerHTML=`
      <button class="show-more-btn" id="showMoreBtn">
        ‚ñº Show More (${a} additional events)
      </button>
    `;const l=document.getElementById("showMoreBtn");let c=!1;l.addEventListener("click",()=>{c=!c,c?(t.activityTimeline.classList.remove("timeline-collapsed"),l.textContent="‚ñ≤ Show Less"):(t.activityTimeline.classList.add("timeline-collapsed"),l.textContent=`‚ñº Show More (${a} additional events)`)})}else t.showMoreContainer.innerHTML=""}function ee(e){const i=[],n=[],o=[],a=new Date;for(let c=29;c>=0;c--){const d=new Date(a);d.setDate(a.getDate()-c);const s=d.toISOString().slice(0,10);i.push(s),n.push(e[s]?e[s].arrivals:0),o.push(e[s]?e[s].completions:0)}if(g){g.data.labels=i,g.data.datasets[0].data=n,g.data.datasets[1].data=o,g.update();return}const l=t.trendChart.getContext("2d");g=new Chart(l,{type:"line",data:{labels:i,datasets:[{label:"Arrivals",data:n,borderColor:"#0d6efd",backgroundColor:"rgba(13,110,253,0.08)",tension:.2},{label:"Completions",data:o,borderColor:"#198754",backgroundColor:"rgba(25,135,84,0.08)",tension:.2}]},options:{responsive:!0,maintainAspectRatio:!0,animation:!1,transitions:{show:{animation:{duration:0}},resize:{animation:{duration:0}}}}})}t.clearActivityBtn?.addEventListener("click",async()=>{if(!r){alert("Please log in");return}if(confirm("Are you sure you want to clear all activity history? This cannot be undone."))try{t.clearActivityBtn.disabled=!0,t.clearActivityBtn.textContent="‚è≥ Clearing...";const e=I(E(p,"events"),x("userUid","==",r.uid));console.log("Querying events for user:",r.uid);const i=await P(e);console.log("Found",i.docs.length,"events to delete");let n=0,o=0;for(const a of i.docs)try{console.log("Deleting event:",a.id),await Q(a.ref),n++}catch(l){console.error("Failed to delete event",a.id,l),o++}console.info(`Successfully deleted ${n} events, ${o} failed`),await new Promise(a=>setTimeout(a,500)),console.log("Reloading stats..."),await $(r.uid),console.log("Stats reloaded"),t.clearActivityBtn.disabled=!1,t.clearActivityBtn.textContent="üóë Clear Activity",alert(`Activity history cleared (${n} events removed)`)}catch(e){console.error("Failed to clear activity history",e),t.clearActivityBtn.disabled=!1,t.clearActivityBtn.textContent="üóë Clear Activity",alert("Could not clear activity history: "+e.message)}});t.redeemBtn?.addEventListener("click",async()=>{if(!r){alert("Please log in");return}try{t.redeemBtn.disabled=!0,t.redeemBtn.textContent="Redeeming...",await N(p,async e=>{const i=k(p,"userRewards",r.uid),n=await e.get(i),o=n.exists()&&n.data().points||0;if(o<1e3)throw new Error("Not enough points to redeem");const a=o-1e3;e.set(i,{points:a,lastUpdated:T(),redemptions:O(1)},{merge:!0})});try{await D(E(p,"userRedemptions"),{userUid:r.uid,amount:1e3,timestamp:T(),source:"statisticsRedeemButton"})}catch(e){console.warn("Could not record redemption entry",e)}await S(r.uid),alert("Redeemed 1000 points successfully!")}catch(e){console.error("Redeem failed",e),alert(e.message||"Redeem failed")}finally{t.redeemBtn&&(t.redeemBtn.disabled=!1,t.redeemBtn.textContent="Redeem 1000")}});t.openStoreBtn?.addEventListener("click",J);t.closeStoreBtn?.addEventListener("click",j);t.rewardsModal?.addEventListener("click",e=>{e.target===t.rewardsModal&&j()});t.seedBtn?.addEventListener("click",async()=>{if(!r){alert("Please log in");return}if(confirm("Create sample events for the last 10 days?"))try{const e=new Date;let i=0;for(let n=0;n<10;n++){const o=new Date(e);o.setDate(e.getDate()-n);const a=o.toISOString(),l=Math.floor(Math.random()*3);for(let d=0;d<l;d++){const s=Math.random()>.4;await D(E(p,"events"),{userUid:r.uid,type:"arrival",timestamp:T(),meta:{scheduledTime:a,onTime:s}}),s&&(i+=20)}const c=Math.floor(Math.random()*5);for(let d=0;d<c;d++)await D(E(p,"events"),{userUid:r.uid,type:"completion",timestamp:T(),meta:{taskId:`seed-${n}-${d}`,taskText:"Seeded task"}}),i+=10}if(i>0){const n=k(p,"userRewards",r.uid);(await R(n)).exists()?await U(n,{points:O(i)}):await W(n,{points:i,lastUpdated:T()})}await $(r.uid),alert("Seed complete")}catch(e){console.error(e),alert("Could not seed data")}});document.getElementById("logoutBtn").addEventListener("click",Y);
