import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{doc as d,getDoc as m,updateDoc as w,arrayUnion as q,arrayRemove as U,setDoc as D,query as B,collection as F,where as b,getDocs as k}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";import{onAuthStateChanged as v}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{ref as N,uploadBytes as S,getDownloadURL as P}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";import{d as c,a as I,s as A}from"./firebaseConfig-xSN_xHYb.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";const M=async(e,t)=>{if(e===t)return;const s=d(c,"users",t),r=await m(s);if(!r.exists())throw new Error("User does not exist.");const n=r.data();n.friends?.includes(e)||n.friendRequests?.includes(e)||await w(s,{friendRequests:q(e)})},O=async(e,t)=>{const s=d(c,"users",e),r=d(c,"users",t),n=await m(s);if(!n.exists())throw new Error("User does not exist");if(!n.data().friendRequests?.includes(t))throw new Error("No friend request exists");await w(s,{friends:q(t),friendRequests:U(t)}),await w(r,{friends:q(e)})},T=async(e,t)=>{const s=d(c,"users",e);await w(s,{friendRequests:U(t)})},f=document.getElementById("profilePic"),L=document.getElementById("imagePicker"),Y=document.getElementById("profileName"),$=document.getElementById("profileEmail"),j="images/Profile.avif";let o=null;v(I,async e=>{if(!e){console.log("No user logged in, redirecting to login..."),window.location.href="index.html";return}o=e;async function t(){const a=d(c,"users",o.uid),i=await m(a);if(!i.exists())return;const g=i.data().friendRequests||[],x=document.getElementById("incomingFriendRequestsList");x.innerHTML="",g.forEach(E=>{const l=document.createElement("li");l.classList.add("list-group-item"),l.textContent="Friend request from: "+E;const R=document.createElement("button");R.textContent="Accept",R.classList.add("btn","btn-success","ms-3"),R.onclick=async()=>{await O(o.uid,E),t()};const y=document.createElement("button");y.textContent="Decline",y.classList.add("btn","btn-danger","ms-2"),y.onclick=async()=>{await T(o.uid,E),t()},l.appendChild(R),l.appendChild(y),x.appendChild(l)})}const s=document.getElementById("friendRequestInput"),r=document.getElementById("sendRequestBtn"),n=document.getElementById("sendRequestMessage");async function p(){const a=s.value.trim();if(!a){n.textContent="Please enter a user ID or email.";return}try{let i;if(a.includes("@")){const h=B(F(c,"users"),b("email","==",a)),g=await k(h);if(g.empty){n.textContent="User not found.";return}i=g.docs[0].id}else if(i=a,!(await m(d(c,"users",i))).exists()){n.textContent="User not found.";return}if(i===o.uid){n.textContent="You cannot add yourself.";return}await M(o.uid,i),n.textContent="Friend request sent!",s.value=""}catch(i){console.error(i),n.textContent=i.message||"Error sending request."}}r.addEventListener("click",p),Y.textContent=e.displayName||"User Name",$.textContent="Email: "+(e.email||"Unknown");const C=d(c,"users",e.uid),u=await m(C);if(console.log("Fetched user doc:",u.exists(),u.data()),u.exists()&&u.data().photoURL){const a=u.data().photoURL;f.src=a,console.log("Using saved photoURL:",a)}else f.src=j,console.log("No photoURL in Firestore, using default image");t()});f.addEventListener("click",()=>{L.click()});L.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;if(!o){alert("You must be logged in to change your picture.");return}const s=URL.createObjectURL(t);f.src=s;try{const r=N(A,`profileImages/${o.uid}`);await S(r,t),console.log("Upload success");const n=await P(r);console.log("Download URL:",n);const p=d(c,"users",o.uid);await D(p,{photoURL:n,displayName:o.displayName||o.email||"Anonymous"},{merge:!0}),console.log("Firestore updated for user:",o.uid),f.src=n,console.log("Profile picture updated!")}catch(r){console.error("Error uploading/saving profile image:",r),alert("Could not upload image. Check console for details.")}});
