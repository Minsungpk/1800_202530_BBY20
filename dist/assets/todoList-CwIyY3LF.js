import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{a as Q,d as p}from"./firebaseConfig-xSN_xHYb.js";import{onAuthStateChanged as Z}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{query as ee,collection as b,where as te,getDocs as oe,setDoc as $,doc as h,serverTimestamp as k,addDoc as H,updateDoc as C,getDoc as ne,increment as se,deleteDoc as q}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";let m=null;async function F(l,s="todo"){try{if(!m){console.log("No logged-in user, skipping notification.");return}await H(b(p,"notifications"),{userUid:m.uid,message:l,type:s,createdAt:k(),read:!1}),console.log("Notification created:",l)}catch(d){console.error("Failed to create notification:",d)}}const B=(()=>{let l="guest";const s={addForm:document.getElementById("addForm"),input:document.getElementById("todoInput"),scheduled:document.getElementById("todoScheduled"),description:document.getElementById("todoDescription"),addFormError:document.getElementById("addFormError"),list:document.getElementById("todoList"),template:document.getElementById("todoItemTemplate"),stats:document.getElementById("stats"),filters:document.querySelectorAll('input[name="filter"]'),clearCompleted:document.getElementById("clearCompleted")};let d=[],x="all",v=0;const I=()=>`todo:${l}`,g=()=>localStorage.setItem(I(),JSON.stringify(d)),L=()=>JSON.parse(localStorage.getItem(I())||"[]"),O=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;function U(){console.log("ðŸŽ‰ 3 on-time completions in a row! Celebrating with confetti!"),v=0;try{typeof confetti<"u"&&(confetti({particleCount:200,spread:100,startVelocity:30,decay:.95,scalar:1.2}),setTimeout(()=>{confetti({particleCount:100,spread:80,startVelocity:20,decay:.9})},300))}catch(e){console.warn("Confetti library not loaded",e)}const t=document.createElement("div");if(t.style.cssText=`
          position: fixed;
          top: 120px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
          color: white;
          padding: 1rem 2rem;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.2);
          font-weight: 700;
          font-size: 1.2rem;
          text-align: center;
          z-index: 10000;
          animation: slideDown 0.5s ease, slideUp 0.5s ease 4.5s forwards;
        `,t.innerHTML="ðŸŽ‰ Amazing! 3 on-time completions in a row! ðŸŽ‰",document.body.appendChild(t),!document.getElementById("celebrationStyles")){const e=document.createElement("style");e.id="celebrationStyles",e.textContent=`
            @keyframes slideDown {
              from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
              to   { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes slideUp {
              from { opacity: 1; transform: translateX(-50%) translateY(0); }
              to   { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
          `,document.head.appendChild(e)}setTimeout(()=>t.remove(),5e3)}function A(t){if(t){if(v++,console.log(`On-time streak: ${v}/3`),v===3)return!0}else console.log("Streak broken! Late completion. Resetting to 0."),v=0;return!1}function u(){s.list.innerHTML="";const t=document.createDocumentFragment(),e=d.filter(o=>x==="all"||x==="active"?!o.done:o.done);if(e.length===0){const o=document.createElement("div");o.className="empty-state",o.innerHTML=x==="all"?'<i class="fas fa-inbox"></i><p>No active tasks. Add one to get started!</p>':x==="active"?'<i class="fas fa-check-circle"></i><p>All caught up! ðŸŽ‰</p>':'<i class="fas fa-list"></i><p>No completed tasks yet.</p>',s.list.appendChild(o),D();return}for(const o of e){const n=s.template.content.firstElementChild.cloneNode(!0);n.dataset.id=o.id,n.querySelector(".toggle").checked=o.done;const c=n.querySelector(".todo-text");c.textContent=o.text;const r=n.querySelector(".todo-scheduled"),i=n.querySelector(".todo-desc");if(o.scheduled){const y=o.scheduled.replace("T"," ");r.innerHTML=`<i class="fas fa-clock"></i> ${y}`}else r.innerHTML="";o.description?i.innerHTML=`<i class="fas fa-map-marker-alt"></i> ${o.description}`:i.innerHTML="",o.done&&n.classList.add("completed");const a=n.querySelector(".status-emoji");o.done&&typeof o.onTimeLocal=="boolean"?(a.textContent=o.onTimeLocal?"âœ… On-Time":"ðŸ•’ Late",a.classList.toggle("text-success",o.onTimeLocal),a.classList.toggle("text-warning",!o.onTimeLocal)):a.textContent="",t.appendChild(n)}s.list.appendChild(t),D()}function D(){const t=d.length,e=d.filter(n=>!n.done).length,o=t-e;if(t===0)s.stats.innerHTML='<i class="fas fa-info-circle me-2"></i>No tasks yet. Add one to get started!';else{const n=Math.round(o/t*100);s.stats.innerHTML=`<i class="fas fa-chart-pie me-2"></i><strong>${o}/${t}</strong> completed (${n}%) â€¢ <strong>${e}</strong> remaining`}}async function M(t,e,o){const n={id:O(),text:t.trim(),done:!1,created:Date.now(),scheduled:e||"",description:o||""};d.push(n),g(),u();try{if(!m)return;await $(h(p,"tasks",n.id),{userUid:m.uid,text:n.text,scheduled:n.scheduled||null,description:n.description||null,done:!1,created:k()}),console.info("Task persisted",n.id),await F(`Task created: ${n.text}`,"todo_created")}catch(c){console.warn("Could not persist task to Firestore",c)}}async function R(t){const e=d.find(n=>n.id===t);if(!e)return;const o=e.done;if(e.done=!e.done,g(),u(),!o&&e.done)try{if(!m){console.log("No current user, skipping completion event");return}if(e.completionRecorded){console.info("Completion already recorded for",e.id);return}const n=new Date().toISOString();let c=!1;if(e.scheduled)try{const a=new Date(e.scheduled);c=!isNaN(a.getTime())&&new Date(n)<=a}catch{c=!1}await H(b(p,"events"),{userUid:m.uid,type:"completion",timestamp:k(),meta:{taskId:e.id,taskText:e.text,scheduledTime:e.scheduled||null,completedTime:n,onTime:c,source:"todoToggle"}}),e.completionRecorded=!0,e.completedLocal=n,e.onTimeLocal=c,g();try{await C(h(p,"tasks",e.id),{done:!0,completedTime:k(),completedTimeClient:n,onTime:c})}catch(a){console.warn("Could not update task doc with completion",a)}const r=h(p,"userRewards",m.uid);(await ne(r)).exists()?await C(r,{points:se(10)}):await $(r,{points:10,lastUpdated:k()}),A(c)&&U(),await F(`Task completed: ${e.text}`,"todo_completed")}catch(n){console.error("Failed to record completion event",n)}}async function N(t){d=d.filter(e=>e.id!==t),g(),u();try{if(!m)return;await q(h(p,"tasks",t)),console.info("Deleted task from Firestore",t)}catch(e){console.warn("Could not delete task from Firestore",e)}}function X(t){const e=d.find(f=>f.id===t);if(!e)return;const o=s.list.querySelector(`[data-id="${t}"]`);if(!o||o.dataset.editing==="true")return;o.dataset.editing="true";const n=o.querySelector(".todo-text"),c=o.querySelector(".todo-scheduled"),r=o.querySelector(".todo-desc"),i=document.createElement("input");i.type="text",i.className="form-control form-control-sm edit-text",i.value=e.text;const a=document.createElement("input");if(a.type="datetime-local",a.className="form-control form-control-sm edit-scheduled mt-1",e.scheduled)try{const f=new Date(e.scheduled);if(!isNaN(f.getTime())){const E=G=>G.toString().padStart(2,"0"),j=f.getFullYear(),J=E(f.getMonth()+1),V=E(f.getDate()),_=E(f.getHours()),P=E(f.getMinutes());a.value=`${j}-${J}-${V}T${_}:${P}`}}catch{}const y=document.createElement("input");y.type="text",y.className="form-control form-control-sm edit-desc mt-1",y.value=e.description||"",n.replaceWith(i),c&&c.replaceWith(a),r&&r.replaceWith(y);const w=o.querySelector(".edit");w.textContent="Save",w.classList.add("btn-success");const T=document.createElement("button");T.type="button",T.className="btn btn-outline-secondary btn-sm cancel ms-1",T.textContent="Cancel",w.after(T),i.focus(),i.selectionStart=i.value.length,T.addEventListener("click",()=>{o.dataset.editing="false",u()},{once:!0})}async function S(t,e){e=(e||"").trim();const o=d.find(c=>c.id===t);if(!o)return;if(!e){N(t);return}const n=s.list.querySelector(`[data-id="${t}"]`);if(n){const c=n.querySelector(".edit-scheduled"),r=n.querySelector(".edit-desc");c&&(o.scheduled=c.value||""),r&&(o.description=r.value||"")}o.text=e,g(),u();try{if(!m)return;await C(h(p,"tasks",t),{text:o.text,scheduled:o.scheduled||null,description:o.description||null}),console.info("Task edits persisted",t)}catch(c){console.warn("Could not persist task edits",c)}}async function Y(){const t=d.filter(e=>e.done).map(e=>e.id);if(d=d.filter(e=>!e.done),g(),u(),!!m)for(const e of t)try{await q(h(p,"tasks",e))}catch(o){console.warn("Could not delete completed task",e,o)}}function W(){s.addForm.addEventListener("submit",t=>{t.preventDefault(),s.addFormError.classList.add("d-none"),document.getElementById("errorText").textContent="";const e=s.input.value.trim();if(!e){document.getElementById("errorText").textContent="Please enter a task name.",s.addFormError.classList.remove("d-none"),s.input.focus();return}const o=s.scheduled.value||"",n=s.description.value||"";M(e,o,n),s.input.value="",s.scheduled.value="",s.description.value="",s.input.focus()}),s.input.addEventListener("input",()=>{s.input.value.trim()&&s.addFormError.classList.add("d-none")}),s.list.addEventListener("click",t=>{const e=t.target.closest(".todo-item");if(!e)return;const o=e.dataset.id;if(t.target.matches(".toggle"))R(o);else if(t.target.matches(".delete"))N(o);else if(t.target.matches(".edit"))if(e.dataset.editing==="true"){const n=e.querySelector(".edit-text"),c=n?n.value:"";S(o,c)}else X(o);else t.target.matches(".cancel")&&(e.dataset.editing="false",u())}),s.list.addEventListener("keydown",t=>{if(t.target instanceof HTMLElement)if(t.target.classList.contains("edit-text")){if(t.key==="Enter"){t.preventDefault();const o=t.target.closest(".todo-item")?.dataset?.id;o&&S(o,t.target.value)}}else t.target.classList.contains("todo-text")&&t.key==="Enter"&&(t.preventDefault(),t.target.blur())}),s.list.addEventListener("focusout",t=>{if(!(t.target instanceof HTMLElement)||!t.target.classList.contains("todo-text"))return;const e=t.target.closest(".todo-item");t.target.removeAttribute("contenteditable"),S(e.dataset.id,t.target.textContent||"")}),s.filters.forEach(t=>t.addEventListener("change",()=>{x=document.querySelector('input[name="filter"]:checked').value,u()})),s.clearCompleted.addEventListener("click",()=>Y()),document.addEventListener("keydown",t=>{if((t.metaKey||t.ctrlKey)&&t.key==="Enter"){const e=s.input.value.trim();e&&(M(e),s.input.value="")}})}async function z(t){if(l=t||"guest",l&&l!=="guest")try{const e=ee(b(p,"tasks"),te("userUid","==",l)),o=await oe(e),n={};o.docs.forEach(i=>{const a=i.data();n[i.id]={id:i.id,text:a.text||"",scheduled:a.scheduled||"",description:a.description||"",done:!!a.done,created:a.created?.toMillis?a.created.toMillis():Date.now(),completionRecorded:!!a.completedTimeClient,completedLocal:a.completedTimeClient||null,onTimeLocal:a.onTime}});const c=L(),r={...n};c.forEach(i=>{r[i.id]?(r[i.id].done=n[i.id].done,r[i.id].onTimeLocal=n[i.id].onTimeLocal,r[i.id].completedLocal=n[i.id].completedLocal):r[i.id]=i}),d=Object.values(r),g(),u();return}catch(e){console.warn("Could not load tasks from Firestore",e)}d=L(),u()}function K(){W(),d=L(),u()}return{init:K,setUser:z}})();document.addEventListener("DOMContentLoaded",()=>{B.init(),Z(Q,l=>{m=l||null,B.setUser(l?l.uid:"guest")})});
