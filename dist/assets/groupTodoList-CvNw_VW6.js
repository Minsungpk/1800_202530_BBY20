import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{a as C,d as p}from"./firebaseConfig-xSN_xHYb.js";import{onAuthStateChanged as A,fetchSignInMethodsForEmail as _}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{query as k,collection as E,where as w,getDocs as G,serverTimestamp as L,doc as f,setDoc as F,getDoc as ee,updateDoc as te,deleteDoc as b,addDoc as oe}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";import{l as re}from"./logout-CMZ6WfQS.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";let v=null,B=[],M=null;const m={groupList:document.getElementById("groupList"),createGroupBtn:document.getElementById("createGroupBtn"),createGroupModal:document.getElementById("createGroupModal"),groupNameInput:document.getElementById("groupNameInput"),groupMembersInput:document.getElementById("groupMembersInput"),saveGroupBtn:document.getElementById("saveGroupBtn")};A(C,async s=>{v=s||null,v&&(await N(),R())});async function N(){if(B=[],!v)return;const s=k(E(p,"groups"),w("members","array-contains",v.email));(await G(s)).forEach(l=>{const c=l.data();B.push({id:l.id,name:c.name,members:c.members||[],createdBy:c.createdBy,createdAt:c.createdAt})})}function R(){if(m.groupList.innerHTML="",B.length===0){m.groupList.innerHTML='<div class="text-muted">No groups yet. Create one!</div>';return}B.forEach(s=>{const t=document.createElement("div");t.className="group-item mb-2 p-2 border rounded",t.innerHTML=`<strong>${s.name}</strong> <span class="text-muted">(${s.members.length} members)</span> <button class="btn btn-sm btn-primary ms-2 selectGroupBtn" data-id="${s.id}">Select</button>`,m.groupList.appendChild(t)}),m.groupList.querySelectorAll(".selectGroupBtn").forEach(s=>{s.addEventListener("click",t=>{M=s.dataset.id,localStorage.setItem("selectedGroupId",M),document.dispatchEvent(new CustomEvent("groupSelected",{detail:{groupId:M}}))})})}m.createGroupBtn.addEventListener("click",()=>{m.createGroupModal.style.display="block"});m.createGroupModal.addEventListener("click",s=>{s.target===m.createGroupModal&&(m.createGroupModal.style.display="none")});m.saveGroupBtn.addEventListener("click",async()=>{const s=m.groupNameInput.value.trim(),t=m.groupMembersInput.value.trim();if(!s||!t){alert("Please enter group name and at least one member email.");return}const l=t.split(",").map(c=>c.trim()).filter(c=>c);if(v){l.includes(v.email)||l.push(v.email);try{const c={name:s,members:l,createdBy:v.uid,createdAt:L()},y=f(E(p,"groups"));await F(y,c),alert("Group created!"),m.createGroupModal.style.display="none",await N(),R()}catch(c){alert("Could not create group."),console.error(c)}}});let u=null;const $=(()=>{let s=null;const t={addForm:document.getElementById("addForm"),input:document.getElementById("todoInput"),assignee:document.getElementById("todoAssignee"),addFormError:document.getElementById("addFormError"),list:document.getElementById("todoList"),template:document.getElementById("todoItemTemplate"),stats:document.getElementById("stats"),filters:document.querySelectorAll('input[name="filter"]'),clearCompleted:document.getElementById("clearCompleted"),groupList:document.getElementById("groupList"),deleteAllGroupsBtn:document.getElementById("deleteAllGroupsBtn"),createGroupBtn:document.getElementById("createGroupBtn"),createGroupModal:document.getElementById("createGroupModal"),groupNameInput:document.getElementById("groupNameInput"),groupMembersInput:document.getElementById("groupMembersInput"),saveGroupBtn:document.getElementById("saveGroupBtn"),selectedGroupName:document.getElementById("selectedGroupName"),selectedGroupMembers:document.getElementById("selectedGroupMembers"),backToGroupsBtn:document.getElementById("backToGroupsBtn"),groupMembersError:document.getElementById("groupMembersError"),deleteCurrentGroupBtn:document.getElementById("deleteCurrentGroupBtn"),groupsView:document.getElementById("groupsView"),tasksView:document.getElementById("tasksView"),filtersBar:document.getElementById("filtersBar"),statsContainer:document.getElementById("statsContainer")};let l=[],c="all",y=[],I=!1;const q=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;function g(){t.list.innerHTML="";const n=document.createDocumentFragment(),e=l.filter(o=>c==="all"||c==="active"?!o.done:o.done);if(console.log(`Rendering with filter "${c}": ${e.length} tasks (total: ${l.length})`),e.length===0){const o=document.createElement("div");o.className="empty-state",o.innerHTML=c==="all"?'<i class="fas fa-inbox"></i><p>No active tasks. Add one to get started!</p>':c==="active"?'<i class="fas fa-check-circle"></i><p>All caught up! ðŸŽ‰</p>':'<i class="fas fa-list"></i><p>No completed tasks yet.</p>',t.list.appendChild(o),T();return}for(const o of e){const r=t.template.content.firstElementChild.cloneNode(!0);r.dataset.id=o.id,r.querySelector(".toggle").checked=o.done;const d=r.querySelector(".todo-text");d.textContent=o.text;const i=r.querySelector(".todo-assignee");o.assignee&&o.assignee!=="Unassigned"?i.innerHTML=`<i class="fas fa-user-circle me-1"></i>${o.assignee}`:i.innerHTML='<i class="fas fa-user-circle me-1"></i>Unassigned',o.done&&r.classList.add("completed"),n.appendChild(r)}t.list.appendChild(n),T()}function T(){const n=l.length,e=l.filter(r=>!r.done).length,o=n-e;if(n===0)t.stats.innerHTML='<i class="fas fa-info-circle me-2"></i>No tasks yet. Add one to get started!';else{const r=Math.round(o/n*100);t.stats.innerHTML=`<i class="fas fa-chart-pie me-2"></i><strong>${o}/${n}</strong> completed (${r}%) â€¢ <strong>${e}</strong> remaining`}}function P(n){const e=(n||"").split(",").map(a=>a.trim().toLowerCase()).filter(Boolean),o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,r=[],d=[],i=new Set;for(const a of e){if(!o.test(a)){d.push(a);continue}i.has(a)||(i.add(a),r.push(a))}return{valid:r,invalid:d}}async function V(n,e){const o={id:q(),text:n.trim(),assignee:e.trim()||"Unassigned",done:!1,created:Date.now()};l.push(o),g();try{if(!u||!s){console.error("Cannot add task: no user or group selected"),console.error("currentUser:",u),console.error("groupId:",s),alert("Cannot add task: Please make sure you are logged in and have selected a group."),l=l.filter(r=>r.id!==o.id),g();return}console.log("Attempting to save task to Firestore..."),console.log("Group ID:",s),console.log("User ID:",u.uid),console.log("Task:",o),await F(f(p,"groupTasks",o.id),{groupId:s,createdBy:u.uid,text:o.text,assignee:o.assignee,done:!1,created:L()}),console.info("âœ“ Group task saved to Firestore:",o.id)}catch(r){console.error("ERROR: Could not persist group task to Firestore"),console.error("Error details:",r),console.error("Error code:",r.code),console.error("Error message:",r.message),l=l.filter(d=>d.id!==o.id),g(),r.code==="permission-denied"?alert(`Failed to save task: Permission denied.

Please add Firestore security rules for the "groupTasks" collection:

match /groupTasks/{taskId} {
  allow read, write: if request.auth != null;
}`):alert(`Failed to save task. Please try again.

Error: `+r.message)}}async function U(n){const e=l.find(o=>o.id===n);if(e){e.done=!e.done,console.log(`Toggled task ${n}: done=${e.done}`),g();try{if(!u)return;await te(f(p,"groupTasks",n),{done:e.done,completedBy:e.done?u.uid:null,completedAt:e.done?L():null}),console.log("âœ“ Group task updated in Firestore")}catch(o){console.warn("Could not update group task in Firestore",o)}}}async function H(n){l=l.filter(e=>e.id!==n),g();try{if(!u)return;await b(f(p,"groupTasks",n)),console.info("Deleted group task from Firestore",n)}catch(e){console.warn("Could not delete group task from Firestore",e)}}async function O(){const n=l.filter(e=>e.done).map(e=>e.id);if(l=l.filter(e=>!e.done),g(),!!u)for(const e of n)try{await b(f(p,"groupTasks",e)),console.info("Deleted completed task from Firestore",e)}catch(o){console.warn("Could not delete completed task",e,o)}}async function Y(){if(!(!u||I)){I=!0;try{console.log("[Groups] One-time load start");const n=k(E(p,"groups"),w("members","array-contains",u.email)),e=await G(n);j(e),console.log("[Groups] One-time load complete")}catch(n){console.warn("[Groups] One-time load error",n)}finally{I=!1}}}function j(n){const e=new Set,o=[];n.docs.forEach(r=>{e.has(r.id)||(e.add(r.id),o.push({id:r.id,...r.data()}))}),y=o,console.log(`[Groups] Snapshot docs=${n.docs.length} stored=${y.length}`,y.map(r=>`${r.name}(${r.members?.length||0})`)),D()}function D(){if(t.groupList.innerHTML="",console.log(`[Render] Total groups=${y.length}`),y.length===0){t.groupList.innerHTML=`
            <div class="empty-groups">
              <i class="fas fa-users"></i>
              <h4>No Groups Yet</h4>
              <p>Create your first group to get started with collaborative tasks</p>
            </div>
          `;return}const n=document.createDocumentFragment();for(const e of y){const o=document.createElement("div");o.className="group-card";const r=new Set((e.members||[]).map(a=>(a||"").toLowerCase())).size,d=(e.name||"?").trim().charAt(0).toUpperCase()||"?",i=Math.abs((e.name||"").split("").reduce((a,h)=>a+h.charCodeAt(0),0)%360);o.innerHTML=`
            <div class="actions-overlay">
              <button class="delete-group-btn" data-group-id="${e.id}"><i class="fas fa-trash"></i> Delete</button>
            </div>
            <div class="d-flex align-items-center gap-3">
              <div class="group-icon" style="background: linear-gradient(135deg, hsl(${i}, 85%, 65%) 0%, hsl(${(i+40)%360}, 85%, 52%) 100%);">
                <span>${d}</span>
              </div>
              <div class="group-details flex-grow-1">
                <h4>${e.name}</h4>
                <div class="group-meta">
                  <span><i class="fas fa-user me-1"></i>${r} member${r!==1?"s":""}</span>
                  <span><i class="fas fa-calendar-plus me-1"></i>Created ${z(e.created)}</span>
                </div>
              </div>
              <i class="fas fa-chevron-right text-muted"></i>
            </div>
            <div class="badge-strip mt-3">
              <span><i class="fas fa-clipboard-list"></i> Tasks</span>
              <span><i class="fas fa-users"></i> Group</span>
            </div>
          `,o.addEventListener("click",a=>{a.target.closest(".delete-group-btn")||$.setGroup(e.id)}),o.querySelector(".delete-group-btn").addEventListener("click",async a=>{a.stopPropagation(),confirm(`Are you sure you want to delete the group "${e.name}"? This will also delete all tasks in this group.`)&&await x(e.id)}),n.appendChild(o)}t.groupList.appendChild(n)}function z(n){if(!n)return"recently";try{const e=n.toDate?n.toDate():new Date(n),r=Math.floor((new Date-e)/(1e3*60*60*24));return r===0?"today":r===1?"yesterday":r<7?`${r} days ago`:r<30?`${Math.floor(r/7)} weeks ago`:e.toLocaleDateString()}catch{return"recently"}}async function Q(n,e){if(u)try{const o=(e||[]).map(h=>(h||"").trim().toLowerCase()).filter(Boolean),r=(u.email||"").trim().toLowerCase(),d=Array.from(new Set([r,...o])),i={name:n.trim(),members:d,created:L(),createdBy:u.uid},a=await oe(E(p,"groups"),i);console.log("Group created with ID:",a.id)}catch(o){console.error("Error creating group:",o)}}async function x(n){if(u)try{await b(f(p,"groups",n)),console.log("Group deleted:",n);const e=k(E(p,"groupTasks"),w("groupId","==",n)),o=await G(e),r=o.docs.map(d=>b(f(p,"groupTasks",d.id)));await Promise.all(r),console.log("Deleted",o.docs.length,"tasks from group"),s===n&&(s=null,l=[],t.groupsView.style.display="block",t.tasksView.style.display="none",g()),await Y()}catch(e){console.error("Error deleting group:",e),alert("Could not delete group. Please try again.")}}async function J(){if(!u||!confirm(`âš ï¸ DELETE ALL YOUR GROUPS?

This will permanently delete ALL groups where you are a member and ALL their tasks. This cannot be undone.

Type YES in the next prompt to confirm.`))return;if(prompt("Type YES to confirm deletion of all your groups:")!=="YES"){alert("Deletion cancelled.");return}try{console.log("[Delete All] Starting bulk delete...");const o=k(E(p,"groups"),w("members","array-contains",u.email)),r=await G(o);for(const d of r.docs){const i=d.id;console.log("[Delete All] Deleting group:",i);const a=k(E(p,"groupTasks"),w("groupId","==",i)),h=await G(a),X=h.docs.map(Z=>b(f(p,"groupTasks",Z.id)));await Promise.all(X),console.log(`[Delete All] Deleted ${h.docs.length} tasks from group ${i}`),await b(f(p,"groups",i))}console.log(`[Delete All] Completed. Deleted ${r.docs.length} groups.`),alert(`âœ“ Successfully deleted ${r.docs.length} group(s) and all their tasks.`),s=null,l=[],y=[],t.groupsView.style.display="block",t.tasksView.style.display="none",D()}catch(o){console.error("[Delete All] Error:",o),alert("Error deleting groups. Please try again or check console.")}}function K(){t.addForm.addEventListener("submit",e=>{e.preventDefault(),t.addFormError.classList.add("d-none"),document.getElementById("errorText").textContent="";const o=t.input.value.trim();if(!o){document.getElementById("errorText").textContent="Please enter a task.",t.addFormError.classList.remove("d-none"),t.input.focus();return}const r=t.assignee.value||"";V(o,r),t.input.value="",t.assignee.value="",t.input.focus()}),t.input.addEventListener("input",()=>{t.input.value.trim()&&t.addFormError.classList.add("d-none")}),t.list.addEventListener("click",e=>{const o=e.target.closest(".todo-item");if(!o)return;const r=o.dataset.id;e.target.matches(".toggle")?U(r):e.target.matches(".delete")&&H(r)}),t.filters.forEach(e=>e.addEventListener("change",()=>{c=document.querySelector('input[name="filter"]:checked').value,g()})),t.clearCompleted.addEventListener("click",()=>O()),t.createGroupBtn.addEventListener("click",()=>{t.createGroupModal.style.display="flex",t.groupNameInput.value="",t.groupMembersInput.value=""}),t.deleteCurrentGroupBtn.addEventListener("click",async()=>{!s||!confirm("Delete this group and all its tasks? This cannot be undone.")||await x(s)});async function n(e){const o=[],r=[];return await Promise.all(e.map(async d=>{try{const i=await _(C,d);i&&i.length>0?o.push(d):r.push(d)}catch(i){console.warn("Email check failed for",d,i),r.push(d)}})),{existing:o,missing:r}}t.saveGroupBtn.addEventListener("click",async()=>{t.groupMembersError.classList.add("d-none"),t.groupMembersError.textContent="";const e=t.groupNameInput.value.trim(),{valid:o,invalid:r}=P(t.groupMembersInput.value);if(!e){t.groupMembersError.textContent="Please provide a group name.",t.groupMembersError.classList.remove("d-none");return}if(o.length===0){t.groupMembersError.textContent="Enter at least one valid email.",t.groupMembersError.classList.remove("d-none");return}r.length>0&&(t.groupMembersError.textContent=`Ignoring invalid: ${r.join(", ")}`,t.groupMembersError.classList.remove("d-none"));const{existing:d,missing:i}=await n(o);if(d.length===0){t.groupMembersError.textContent="None of the provided emails are registered users.",t.groupMembersError.classList.remove("d-none");return}if(i.length>0){const a=t.groupMembersError.textContent,h=`Excluded unregistered: ${i.join(", ")}`;t.groupMembersError.textContent=a?a+" | "+h:h,t.groupMembersError.classList.remove("d-none")}await Q(e,d),t.createGroupModal.style.display="none"}),window.addEventListener("click",e=>{e.target===t.createGroupModal&&(t.createGroupModal.style.display="none")}),t.backToGroupsBtn.addEventListener("click",()=>{S(null)}),t.deleteAllGroupsBtn&&t.deleteAllGroupsBtn.addEventListener("click",async()=>{await J()})}async function S(n){if(s=n,s&&s!=="none")try{const e=await ee(f(p,"groups",s));if(e.exists()){const o=e.data();t.groupsView.style.display="none",t.tasksView.style.display="block",t.selectedGroupName.textContent=o.name||"Unnamed Group",t.selectedGroupMembers.textContent=`${(o.members||[]).length} member${(o.members||[]).length!==1?"s":""}`;const r=k(E(p,"groupTasks"),w("groupId","==",s));l=(await G(r)).docs.map(i=>{const a=i.data();return{id:i.id,text:a.text||"",assignee:a.assignee||"Unassigned",done:!!a.done,created:a.created?.toMillis?a.created.toMillis():Date.now()}}),console.log("âœ“ Loaded group tasks from Firestore:",l.length,"tasks")}}catch(e){console.error("ERROR loading group tasks:",e)}else t.groupsView.style.display="block",t.tasksView.style.display="none",l=[];g()}function W(){K(),s=null,t.groupsView.style.display="block",t.tasksView.style.display="none",g()}return{init:W,setGroup:S}})();document.addEventListener("DOMContentLoaded",()=>{$.init(),A(C,s=>{u=s||null,console.log("[Auth] User changed, email=",u?.email),groups=[],u?subscribeGroups():(els.groupsView.classList.remove("loading"),renderGroups(),unsubscribeGroups&&(unsubscribeGroups(),unsubscribeGroups=null))})});document.addEventListener("groupSelected",s=>{const t=s.detail.groupId;$.setGroup(t)});document.getElementById("logoutBtn").addEventListener("click",re);
