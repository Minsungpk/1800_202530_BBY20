<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="./styles/style.css" />
</head>

<body>
  <div id="nav">
    <a href="settingspage.html">
      <img src="images/gear.png" class="setting" alt="Settings">
    </a>
  </div>

  <div id="profile">
    <!-- Profile image -->
    <img src="images/ryan.png" class="profilepicture" id="profilePic" alt="Profile picture">

    <!-- Hidden file input (for choosing a new image) -->
    <input type="file" id="imagePicker" accept="image/*" style="display:none;">

    <p id="profileName">Ryan</p>
    <p id="profileEmail">Email:</p>
    <p>Request friends</p>
    <p>Settings</p>
  </div>

  <!-- Footer navigation -->
  <footer class="footer">
    <div class="footer-icon" onclick="window.location.href='landing.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-map-fill" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.598-.49L10.5.99 5.598.01a.5.5 0 0 0-.196 0l-5 1A.5.5 0 0 0 0 1.5v14a.5.5 0 0 0 .598.49l4.902-.98 4.902.98a.5.5 0 0 0 .196 0l5-1A.5.5 0 0 0 16 14.5zM5 14.09V1.11l.5-.1.5.1v12.98l-.402-.08a.5.5 0 0 0-.196 0zm5 .8V1.91l.402.08a.5.5 0 0 0 .196 0L11 1.91v12.98l-.5.1z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="window.location.href='joinEvent.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-compass-fill" viewBox="0 0 16 16">
        <path d="M15.5 8.516a7.5 7.5 0 1 1-9.462-7.24A1 1 0 0 1 7 0h2a1 1 0 0 1 .962 1.276 7.5 7.5 0 0 1 5.538 7.24m-3.61-3.905L6.94 7.439 4.11 12.39l4.95-2.828 2.828-4.95z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="openSheet()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="window.location.href='statistics.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"/>
      </svg>
    </div>
    
    <div class="footer-icon" onclick="window.location.href='index.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
        <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
      </svg>
    </div>
  </footer>

  <!-- Firebase + profile logic -->
  <script type="module">
    // 1. IMPORT FIREBASE MODULES
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

    // 2. FIREBASE CONFIG (must match your project)
    // âš ï¸ If this bucket name is wrong, update it to what you see in
    // Firebase Console â†’ Storage â†’ Bucket name.
    const firebaseConfig = {
  apiKey: "AIzaSyDD_2z29qDHPVXeSXyZ0T9VO_n_PcW1EqU",
  authDomain: "group-project-8a6ee.firebaseapp.com",
  projectId: "group-project-8a6ee",
  storageBucket: "group-project-8a6ee.firebasestorage.app",
  messagingSenderId: "922685674876",
  appId: "1:922685674876:web:6edeac0ff4fb485db780f9",
  measurementId: "G-1LCVJ62HEL"
};

    // 3. INITIALIZE
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // 4. DOM ELEMENTS
    const profilePic = document.getElementById("profilePic");
    const imagePicker = document.getElementById("imagePicker");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");

    const DEFAULT_IMG = "images/ryan.png";
    let currentUser = null;

    // 5. AUTH STATE â€“ load user + saved photo
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("No user logged in, redirecting to login...");
        window.location.href = "login.html";   // adjust if needed
        return;
      }

      currentUser = user;

      // Show basic info
      profileName.textContent = user.displayName || "Anonymous";
      profileEmail.textContent = "Email: " + (user.email || "Unknown");

      // Load saved profile photo from Firestore, if any
      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userDocRef);

      console.log("Fetched user doc:", userSnap.exists(), userSnap.data());

      if (userSnap.exists() && userSnap.data().photoURL) {
        const url = userSnap.data().photoURL;
        profilePic.src = url;
        console.log("Using saved photoURL:", url);
      } else {
        profilePic.src = DEFAULT_IMG;
        console.log("No photoURL in Firestore, using default image");
      }
    });

    // 6. CLICK IMAGE â†’ OPEN FILE PICKER
    profilePic.addEventListener("click", () => {
      imagePicker.click();
    });

    // 7. FILE PICKED â†’ PREVIEW + UPLOAD + SAVE URL
    imagePicker.addEventListener("change", async (event) => {
      const file = event.target.files[0];

      if (!file) return;
      if (!currentUser) {
        alert("You must be logged in to change your picture.");
        return;
      }

      // Local preview right away
      const localUrl = URL.createObjectURL(file);
      profilePic.src = localUrl;

      try {
        // Upload to Firebase Storage
        const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
        await uploadBytes(storageRef, file);
        console.log("âœ… Upload success");

        // Get public download URL
        const downloadURL = await getDownloadURL(storageRef);
        console.log("âœ… Download URL:", downloadURL);

        // Save URL to Firestore
        const userDocRef = doc(db, "users", currentUser.uid);
        await setDoc(
          userDocRef,
          {
            photoURL: downloadURL,
            displayName: currentUser.displayName || currentUser.email || "Anonymous",
          },
          { merge: true }
        );
        console.log("âœ… Firestore updated for user:", currentUser.uid);

        // Use final URL
        profilePic.src = downloadURL;

        console.log("Profile picture updated!");
      } catch (err) {
        console.error("ðŸ”¥ Error uploading/saving profile image:", err);
        alert("Could not upload image. Check console for details.");
      }
    });
  </script>
</body>
</html>
