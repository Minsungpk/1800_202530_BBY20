<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="./styles/style.css" />
  </head>

  <body>
    <div id="nav">
      <a href="settingspage.html">
        <img src="images/gear-svgrepo-com.png" class="setting" alt="Settings" />
      </a>
      <a href="userevents.html">
        <img
          src="images/calendar-exclamation-svgrepo-com.png"
          class="setting"
          alt="Settings"
        />
      </a>
      <a href="notifications.html">
        <img src="images/alarm-alert-attention-bell-notification-ring-svgrepo-com.png" class="setting" alt="Settings" />
      </a>
    </div>

    <div id="profile">
      <img
        src="images/Profile.avif"
        class="profilepicture"
        id="profilePic"
        alt="Profile picture"
      />

      <input
        type="file"
        id="imagePicker"
        accept="image/*"
        style="display: none"
      />

      <p id="profileName">Username</p>
      <p id="profileEmail">Email:</p>
      <a href="index.html"
        ><img
          src="images/logout.png
        "
          alt="logoutBtn"
          width="100px"
      /></a>
      <caption>
        <i>Logout</i>
      </caption>
    </div>
    <!-- Send Friend Request Section -->
    <div id="sendFriendRequestSection" class="mt-4">
      <h3>Send Friend Request</h3>
      <div class="input-group mb-3">
        <input
          type="text"
          id="friendRequestInput"
          class="form-control"
          placeholder="Enter user's email or ID"
        />
        <button class="btn btn-info" id="sendRequestBtn">Send</button>
      </div>
      <p id="sendRequestMessage" class="text-success"></p>
    </div>

    <!-- Incoming Friend Requests Section -->
    <div id="incomingFriendRequestsSection" class="mt-4">
      <h3>Incoming Friend Requests</h3>
      <ul id="incomingFriendRequestsList" class="list-group"></ul>
    </div>

    <!-- Sent Friend Requests Section (optional) -->
    <div id="sentFriendRequestsSection" class="mt-4">
      <h3>Sent Friend Requests</h3>
      <ul id="sentFriendRequestsList" class="list-group"></ul>
    </div>

    <footer class="footer">
      <div class="footer-icon" onclick="window.location.href='landing.html'">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-map-fill"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M16 .5a.5.5 0 0 0-.598-.49L10.5.99 5.598.01a.5.5 0 0 0-.196 0l-5 1A.5.5 0 0 0 0 1.5v14a.5.5 0 0 0 .598.49l4.902-.98 4.902.98a.5.5 0 0 0 .196 0l5-1A.5.5 0 0 0 16 14.5zM5 14.09V1.11l.5-.1.5.1v12.98l-.402-.08a.5.5 0 0 0-.196 0zm5 .8V1.91l.402.08a.5.5 0 0 0 .196 0L11 1.91v12.98l-.5.1z"
          />
        </svg>
      </div>

      <div class="footer-icon" onclick="window.location.href='joinEvent.html'">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-compass-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M15.5 8.516a7.5 7.5 0 1 1-9.462-7.24A1 1 0 0 1 7 0h2a1 1 0 0 1 .962 1.276 7.5 7.5 0 0 1 5.538 7.24m-3.61-3.905L6.94 7.439 4.11 12.39l4.95-2.828 2.828-4.95z"
          />
        </svg>
      </div>

      <div class="footer-icon" onclick="openSheet()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-plus-circle-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"
          />
        </svg>
      </div>

      <div class="footer-icon" onclick="window.location.href='statistics.html'">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-bar-chart-line-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"
          />
        </svg>
      </div>

      <div class="footer-icon" onclick="window.location.href='profile.html'">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-person-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"
          />
        </svg>
      </div>
    </footer>

    <!-- Bottom sheet (create menu) -->
    <div id="bottomSheet" class="bottom-sheet">
      <div class="sheet-content">
        <button class="close-btn" onclick="closeSheet()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="currentColor"
            class="bi bi-x-lg"
            viewBox="0 0 16 16"
          >
            <path
              d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"
            />
          </svg>
        </button>

        <h5 class="sheet-title">Create</h5>

        <button
          class="sheet-btn"
          onclick="window.location.href='todolist.html'"
        >
          To-Do List
        </button>

        <button
          class="sheet-btn"
          onclick="window.location.href='groupTodoList.html'"
        >
          Group To-Do List
        </button>

        <button
          class="sheet-btn"
          onclick="window.location.href='launchevent.html'"
        >
          Events
        </button>
      </div>
    </div>

    <script type="module">
      import { sendFriendRequest as sendFriendRequestToDB } from "./src/friends.js";

      import {
        acceptFriendRequest,
        declineFriendRequest,
      } from "./src/friends.js";

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDD_2z29qDHPVXeSXyZ0T9VO_n_PcW1EqU",
        authDomain: "group-project-8a6ee.firebaseapp.com",
        projectId: "group-project-8a6ee",
        storageBucket: "group-project-8a6ee.firebasestorage.app",
        messagingSenderId: "922685674876",
        appId: "1:922685674876:web:6edeac0ff4fb485db780f9",
        measurementId: "G-1LCVJ62HEL",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      const profilePic = document.getElementById("profilePic");
      const imagePicker = document.getElementById("imagePicker");
      const profileName = document.getElementById("profileName");
      const profileEmail = document.getElementById("profileEmail");

      const DEFAULT_IMG = "images/Profile.avif";
      let currentUser = null;

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("No user logged in, redirecting to login...");
          window.location.href = "login.html";
          return;
        }
        async function loadFriendRequests() {
          const userDocRef = doc(db, "users", currentUser.uid);
          const userSnap = await getDoc(userDocRef);

          if (!userSnap.exists()) return;

          const data = userSnap.data();
          const requests = data.friendRequests || [];

          const list = document.getElementById("incomingFriendRequestsList"); // updated ID
          list.innerHTML = "";

          requests.forEach((requesterId) => {
            const li = document.createElement("li");
            li.classList.add("list-group-item");
            li.textContent = "Friend request from: " + requesterId;

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = "Accept";
            acceptBtn.classList.add("btn", "btn-success", "ms-3");
            acceptBtn.onclick = async () => {
              await acceptFriendRequest(currentUser.uid, requesterId);
              loadFriendRequests(); // refresh list
            };

            const declineBtn = document.createElement("button");
            declineBtn.textContent = "Decline";
            declineBtn.classList.add("btn", "btn-danger", "ms-2");
            declineBtn.onclick = async () => {
              await declineFriendRequest(currentUser.uid, requesterId);
              loadFriendRequests(); // refresh list
            };

            li.appendChild(acceptBtn);
            li.appendChild(declineBtn);
            list.appendChild(li);
          });
        }

        currentUser = user;
        const friendRequestInput =
          document.getElementById("friendRequestInput");
        const sendRequestBtn = document.getElementById("sendRequestBtn");
        const sendRequestMessage =
          document.getElementById("sendRequestMessage");

        async function sendFriendRequest() {
          const targetIdOrEmail = friendRequestInput.value.trim();
          if (!targetIdOrEmail) {
            sendRequestMessage.textContent = "Please enter a user ID or email.";
            return;
          }

          try {
            let toUserId;

            if (targetIdOrEmail.includes("@")) {
              // Input is email â†’ query Firestore
              const q = query(
                collection(db, "users"),
                where("email", "==", targetIdOrEmail)
              );
              const querySnapshot = await getDocs(q);

              if (querySnapshot.empty) {
                sendRequestMessage.textContent = "User not found.";
                return;
              }

              toUserId = querySnapshot.docs[0].id; // UID
            } else {
              // Input is UID
              const userSnap = await getDoc(doc(db, "users", targetIdOrEmail));
              if (!userSnap.exists()) {
                sendRequestMessage.textContent = "User not found.";
                return;
              }
              toUserId = targetIdOrEmail;
            }

            await sendFriendRequestToDB(currentUser.uid, toUserId);

            sendRequestMessage.textContent = "Friend request sent!";
            friendRequestInput.value = "";
          } catch (err) {
            console.error("Error sending friend request:", err);
            sendRequestMessage.textContent = "Error sending request.";
          }
        }

        sendRequestBtn.addEventListener("click", sendFriendRequest);

        profileName.textContent = user.displayName || "User Name";
        profileEmail.textContent = "Email: " + (user.email || "Unknown");

        const userDocRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userDocRef);

        console.log("Fetched user doc:", userSnap.exists(), userSnap.data());
        if (userSnap.exists() && userSnap.data().photoURL) {
          const url = userSnap.data().photoURL;
          profilePic.src = url;
          console.log("Using saved photoURL:", url);
        } else {
          profilePic.src = DEFAULT_IMG;
          console.log("No photoURL in Firestore, using default image");
        }
        loadFriendRequests();
      });

      profilePic.addEventListener("click", () => {
        imagePicker.click();
      });

      imagePicker.addEventListener("change", async (event) => {
        const file = event.target.files[0];

        if (!file) return;
        if (!currentUser) {
          alert("You must be logged in to change your picture.");
          return;
        }

        const localUrl = URL.createObjectURL(file);
        profilePic.src = localUrl;

        try {
          const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
          await uploadBytes(storageRef, file);
          console.log("Upload success");

          const downloadURL = await getDownloadURL(storageRef);
          console.log("Download URL:", downloadURL);

          const userDocRef = doc(db, "users", currentUser.uid);
          await setDoc(
            userDocRef,
            {
              photoURL: downloadURL,
              displayName:
                currentUser.displayName || currentUser.email || "Anonymous",
            },
            { merge: true }
          );
          console.log("Firestore updated for user:", currentUser.uid);

          profilePic.src = downloadURL;

          console.log("Profile picture updated!");
        } catch (err) {
          console.error("Error uploading/saving profile image:", err);
          alert("Could not upload image. Check console for details.");
        }
      });
    </script>

    <!-- Bottom-sheet behaviour -->
    <script src="/design/bottom-window.js"></script>
  </body>
</html>
