<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timely â€“ Profile</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
    crossorigin="anonymous"
  />

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="./styles/profile.css" />
  <link rel="stylesheet" href="./styles/style.css" />

</head>

<body class="bg-light">
    <div id="nav">
      <a href="index.html">
        <img
          src="images/logout-box.svg"
          class="logout"
          alt="Logout"
        />
      <a href="userevents.html">
        <img
          src="images/event-calendar.svg"
          class="events"
          alt="Events"
        />
      </a>
    </div>

    <div id="profile">
      <img
        src="images/Profile.avif"
        class="profilepicture"
        id="profilePic"
        alt="Profile picture"
      />

      <input
        type="file"
        id="imagePicker"
        accept="image/*"
        style="display: none"
      />

      <p id="profileName">Username</p>
      <p id="profileEmail">Email:</p>
      
    </div>

    <div id="sendFriendRequestSection" class="mt-4">
      <h3>Send Friend Request</h3>
      <div class="input-group mb-3">
        <input
          type="text"
          id="friendRequestInput"
          class="form-control"
          placeholder="Enter user's email or ID"
        />
        <button class="send-request-btn" id="sendRequestBtn">Send</button>
      </div>
      <p id="sendRequestMessage" class="text-success"></p>
    </div>
 
    <!-- Incoming Friend Requests Card -->
    <div class="friends-card mt-4">
      <h4>Incoming Friend Requests</h4>
      <ul id="incomingFriendRequestsList" class="list-group list-group-flush"></ul>
    </div>


    <!-- Sent Friend Requests Card -->
    <div class="friends-card mt-4">
      <h4>Sent Friend Requests</h4>
      <ul id="sentFriendRequestsList" class="list-group list-group-flush"></ul>
    </div>


  <!-- Footer navigation -->
  <footer class="footer">
    <div class="footer-icon" onclick="window.location.href='landing.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-map-fill" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.598-.49L10.5.99 5.598.01a.5.5 0 0 0-.196 0l-5 1A.5.5 0 0 0 0 1.5v14a.5.5 0 0 0 .598.49l4.902-.98 4.902.98a.5.5 0 0 0 .196 0l5-1A.5.5 0 0 0 16 14.5zM5 14.09V1.11l.5-.1.5.1v12.98l-.402-.08a.5.5 0 0 0-.196 0zm5 .8V1.91l.402.08a.5.5 0 0 0 .196 0L11 1.91v12.98l-.5.1z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="window.location.href='joinEvent.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-compass-fill" viewBox="0 0 16 16">
        <path d="M15.5 8.516a7.5 7.5 0 1 1-9.462-7.24A1 1 0 0 1 7 0h2a1 1 0 0 1 .962 1.276 7.5 7.5 0 0 1 5.538 7.24m-3.61-3.905L6.94 7.439 4.11 12.39l4.95-2.828 2.828-4.95z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="openSheet()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
      </svg>
    </div>

    <div class="footer-icon" onclick="window.location.href='statistics.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-line-fill" viewBox="0 0 16 16">
        <path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1z"/>
      </svg>
    </div>
    
    <div class="footer-icon" onclick="window.location.href='profile.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
        <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
      </svg>
    </div>
  </footer>

  <!-- Bottom window -->
  <div id="bottomSheet" class="bottom-sheet">
    <div class="sheet-content">
      <button class="close-btn" onclick="closeSheet()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
          <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
        </svg>
      </button>

      <h5 class="sheet-title">Create</h5>

      <button class="sheet-btn" onclick="window.location.href='todolist.html'">
        To-Do List
      </button>

      <button class="sheet-btn" onclick="window.location.href='groupTodoList.html'">
        Group To-Do List
      </button>

      <button class="sheet-btn" onclick="window.location.href='launchevent.html'">
        Events
      </button>
    </div>
  </div>
  <script src="./design/bottom-window.js"></script>


    <script type="module">
      import {
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      import {
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

      import { db, auth, storage } from "./src/firebaseConfig.js";

      import {
        sendFriendRequest as sendFriendRequestToDB,
        acceptFriendRequest,
        declineFriendRequest,
      } from "./src/friends.js";

      const profilePic = document.getElementById("profilePic");
      const imagePicker = document.getElementById("imagePicker");
      const profileName = document.getElementById("profileName");
      const profileEmail = document.getElementById("profileEmail");

      const DEFAULT_IMG = "images/Profile.avif";
      let currentUser = null;

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          console.log("No user logged in, redirecting to login...");
          window.location.href = "index.html";
          return;
        }

        currentUser = user;

        async function loadFriendRequests() {
          const userDocRef = doc(db, "users", currentUser.uid);
          const userSnap = await getDoc(userDocRef);

          if (!userSnap.exists()) return;

          const data = userSnap.data();
          const requests = data.friendRequests || [];

          const list = document.getElementById("incomingFriendRequestsList");
          list.innerHTML = "";

          requests.forEach((requesterId) => {
            const li = document.createElement("li");
            li.classList.add("list-group-item");
            li.textContent = "Friend request from: " + requesterId;

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = "Accept";
            acceptBtn.classList.add("btn", "btn-success", "ms-3");
            acceptBtn.onclick = async () => {
              await acceptFriendRequest(currentUser.uid, requesterId);
              loadFriendRequests();
            };

            const declineBtn = document.createElement("button");
            declineBtn.textContent = "Decline";
            declineBtn.classList.add("btn", "btn-danger", "ms-2");
            declineBtn.onclick = async () => {
              await declineFriendRequest(currentUser.uid, requesterId);
              loadFriendRequests();
            };

            li.appendChild(acceptBtn);
            li.appendChild(declineBtn);
            list.appendChild(li);
          });
        }

        const friendRequestInput =
          document.getElementById("friendRequestInput");
        const sendRequestBtn = document.getElementById("sendRequestBtn");
        const sendRequestMessage =
          document.getElementById("sendRequestMessage");

        async function sendFriendRequest() {
          const targetIdOrEmail = friendRequestInput.value.trim();
          if (!targetIdOrEmail) {
            sendRequestMessage.textContent = "Please enter a user ID or email.";
            return;
          }

          try {
            let toUserId;

            if (targetIdOrEmail.includes("@")) {
              const q = query(
                collection(db, "users"),
                where("email", "==", targetIdOrEmail)
              );
              const querySnapshot = await getDocs(q);
              if (querySnapshot.empty) {
                sendRequestMessage.textContent = "User not found.";
                return;
              }
              toUserId = querySnapshot.docs[0].id;
            } else {
              toUserId = targetIdOrEmail;
              const userSnap = await getDoc(doc(db, "users", toUserId));
              if (!userSnap.exists()) {
                sendRequestMessage.textContent = "User not found.";
                return;
              }
            }

            if (toUserId === currentUser.uid) {
              sendRequestMessage.textContent = "You cannot add yourself.";
              return;
            }

            await sendFriendRequestToDB(currentUser.uid, toUserId);
            sendRequestMessage.textContent = "Friend request sent!";
            friendRequestInput.value = "";
          } catch (err) {
            console.error(err);
            sendRequestMessage.textContent =
              err.message || "Error sending request.";
          }
        }

        sendRequestBtn.addEventListener("click", sendFriendRequest);

        profileName.textContent = user.displayName || "User Name";
        profileEmail.textContent = "Email: " + (user.email || "Unknown");

        const userDocRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userDocRef);

        console.log("Fetched user doc:", userSnap.exists(), userSnap.data());
        if (userSnap.exists() && userSnap.data().photoURL) {
          const url = userSnap.data().photoURL;
          profilePic.src = url;
          console.log("Using saved photoURL:", url);
        } else {
          profilePic.src = DEFAULT_IMG;
          console.log("No photoURL in Firestore, using default image");
        }

        loadFriendRequests();
      });

      profilePic.addEventListener("click", () => {
        imagePicker.click();
      });

      imagePicker.addEventListener("change", async (event) => {
        const file = event.target.files[0];

        if (!file) return;
        if (!currentUser) {
          alert("You must be logged in to change your picture.");
          return;
        }

        const localUrl = URL.createObjectURL(file);
        profilePic.src = localUrl;

        try {
          const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
          await uploadBytes(storageRef, file);
          console.log("Upload success");

          const downloadURL = await getDownloadURL(storageRef);
          console.log("Download URL:", downloadURL);

          const userDocRef = doc(db, "users", currentUser.uid);
          await setDoc(
            userDocRef,
            {
              photoURL: downloadURL,
              displayName:
                currentUser.displayName || currentUser.email || "Anonymous",
            },
            { merge: true }
          );
          console.log("Firestore updated for user:", currentUser.uid);

          profilePic.src = downloadURL;

          console.log("Profile picture updated!");
        } catch (err) {
          console.error("Error uploading/saving profile image:", err);
          alert("Could not upload image. Check console for details.");
        }
      });
    </script>

   
<script src="/bottom-window.js"></script>
</body>
</html>
